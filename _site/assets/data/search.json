[
  
  {
    "title"    : "How to find a needle in the haystack, using z-scores and Q-Q plots",
    "category" : "pollen, data cleaning",
    "url"      : "/pollen/data%20cleaning/2021/11/23/Data-cleaning-how-to-find-needle-haystack/",
    "date"     : "November 23, 2021",
    "excerpt"  : "Outliers caused by typos can profoundly distort a dataset if they generate an impossibly large or small value. The same property also makes them easy to identiy during data cleaning.\n\nBut what if a typo in a time-series is exceptional not due to i...",
    "content"  : "Outliers caused by typos can profoundly distort a dataset if they generate an impossibly large or small value. The same property also makes them easy to identiy during data cleaning.\n\nBut what if a typo in a time-series is exceptional not due to its value, but due to the time when it occurs? Such small errors can be hard to identify, especially in a time-series such as 30 years of daily pollen counts. In this post, I show an approach I used for finding the needle in a haystack - or a handful of pollen grains outside of the hayfever season.\n\n\n\n\nPlants release their pollen at quite specific times of the year. Hazel, for example, pollinates in the winter months: in 2007, hazel pollen irritated the allergy sufferers between mid-January and mid-March.\n\nOf course there will be some occasional pollen grains before or after that typical time - there are always variations between seasons -, but we don’t expect to see hazel pollen in summer or autumn.\n\nSo how come hazel pollen was detected in August 2017, as well as October and November 2016? How plausible or implausible are these observations?\n\nHazel pollen in the summer ?\nTo look more closely into this, let’s visually compare the 2017 season to other hazel pollen seasons in the same decade.\n\n\n\nHere I’m adding a 30-day rolling sum (orange line) to show when the main pollen season happens, and I use a log-axis to emphasise single-digit pollen concentrations.\n\nThis shows more clearly how out of place the pollen grains in October and August are - in 10 seasons, this only happened once.\n\nA bit of botanical knowledge is extremely helpful here: Hazel pollen is produced in catkins, which  start their development in the summer, and mature in October-November.\n\nIn fact, hazel catkins usually need a cold period before they start producing pollen. So unless a strange mutation has occured in nearby hazel bushes, observations of hazel pollen in August and October are likely erroneous.\n\nEven if these observations are real - perhaps months-old pollen was re-suspended in the air from leaves or old catkins that were disturbed - they are not helpful if we want to analyse and model typical hazel pollen seasons, and removing these data points is warranted.\n\nAlthough it’s just a handful of pollen grains, in the wrong place they can seriously distort our descriptive metrics of pollen seasons.\n\nA hazel pollen season usually lasts for around 60 days (if defined as the duration from the 1. until 99. percentile of a season’s pollen). So if the start of the 2017 season is determined erroneously to take place in October 2016, and the season end in August 2017, then the duration would be 10 months rather than 2. Such typos can result in grotesque outliers.\n\nstandard scores\nif we knew the distrubution, we could calculate the probability of obtianing a particular z-score. In the p[resent case, we don’t care: we just want to check if the most unlikely ones are fine.\n\nHow can we ensure such outliers are detected? For the main 6 types of allergenic pollen in the dataset, there are 10885 daily observations, with 431762 pollen grains over 10899 days - finding handfuls of pollen grains in the wrong time of the year is about finding needles in haystacks.\n\nI used an approach of identfying the pollen seasons with the least likely characteristics, and then spot-checking the individual daily observations which the season characteristics were based on to see if they are compatible with botanical knowledge.\n\nAfter calculating a bunch of descriptive metrics for the 30 seasons in the dataset, I converted these to z-scores, aka standard scores.\n\nEach z-score tells us how many standard deviations that season metric is away from the mean of the 30 seasons. So if we look at the z-scores with the largest absolute value, we can quickly identify the most unusual ones.\n\nAnd if the same season is unusual for several metrics, it’s worth checking if it genuinely was unusual or if something’s off.\n\nThese are the 20 largest z-scores:\n\n\n  \n    \n      pollen_type\n      metric\n      year\n      z-score\n    \n  \n  \n    \n      Alnus\n      season_total\n      2016\n      4.158800\n    \n    \n       \n      high_pollen_days\n      2016\n      3.978652\n    \n    \n      Corylus\n      median_count\n      2011\n      3.952323\n    \n    \n       \n      moderate_pollen_days\n      2018\n      3.462771\n    \n    \n       \n      last_pollen\n      1993\n      3.197012\n    \n    \n      Alnus\n      first_pollen\n      1991\n      3.185730\n    \n    \n      Corylus\n      high_pollen_days\n      2011\n      3.151175\n    \n    \n       \n      last_pollen\n      1992\n      3.082012\n    \n    \n       \n      tr20_end\n      2008\n      -3.010488\n    \n    \n       \n      tr3d20_end\n      2008\n      -3.010488\n    \n    \n      Betula\n      tr30\n      1998\n      2.855324\n    \n    \n       \n      first_to_last\n      2009\n      -2.815287\n    \n    \n      Corylus\n      tr30\n      2018\n      2.804770\n    \n    \n      Alnus\n      peak_value\n      2019\n      2.796124\n    \n    \n      Betula\n      trmov5_11_start\n      1996\n      2.705589\n    \n    \n       \n      median_count\n      2006\n      2.681453\n    \n    \n      Corylus\n      first_pollen\n      1991\n      2.659328\n    \n    \n      Betula\n      season_total\n      2020\n      2.648397\n    \n    \n      Alnus\n      median_count\n      2016\n      2.636155\n    \n    \n       \n      allergy_period\n      2018\n      2.632686\n    \n  \n\n\nAccording to the empirical rule, just 0.3% of z-scores should be greater than +3/-3 if the distribution is Gaussian. Pollen season metrics typically dont have a Gaussian distribution, but we can rely on Chebyshev’s inequality according to which at the very most 11.1% are expected to have a z-score greater than 3/-3.\n\nThe largest z-scores for hazel (Corylus) are all linked to the 2017 season, which we’ve looked at already.\n\nCleaning birch pollen seasons\nFor birch (Betula), the seasons 2018, 2005,1992 stand out. Let’s check them out!\n\n\n\n2004 is a typical season - this is our ‘control’. The handful of September birch pollen grains in 1992 and 2005 are exceedingly implausible.\n\nThe 2018 pollen grain recorded in February is even more implausible: birch catkins only start their development in March, so they aren’t producing pollen in February.\n\nCleaning grass pollen seasons\nThe most unusual grass season metrics are associated with the year 2007:\n\n\n  \n    \n      pollen_type\n      metric\n      year\n      z-score\n    \n  \n  \n    \n      Gramineae\n      trmov5_11\n      2007\n      3.344516\n    \n    \n       \n      duration_2p5to97p5\n      2007\n      3.084482\n    \n    \n       \n      duration_eaaci\n      2007\n      2.859359\n    \n    \n       \n      tr3d20_start\n      2007\n      -2.791684\n    \n    \n       \n      tr20_start\n      2007\n      -2.791684\n    \n    \n       \n      tr30_start\n      2007\n      -2.718110\n    \n    \n       \n      trmov5_5\n      2007\n      2.703028\n    \n    \n       \n      moderate_pollen_days\n      1998\n      2.667299\n    \n    \n       \n      start_5pc\n      2007\n      -2.653617\n    \n  \n\n\nLet’s look at the 2007 pollen concentration data in the context of nearby seasons, as well as a more detailed view of daily observations:\n\n\n\nThough it may have started a bit earlier and lasted a bit longer, the 2007 does not look fundamentally different from others, and the daily counts look fine.\n\nThere is no reason to suspect erroneous data - 2007 was probably just the longest season in the 1991-2020 period.\n\nCleaning alder pollen seasons\nHow about alder (Alnus)? The 2016 season had high z-scores for the total amount of pollen produced in the season, and the number of days with especially high pollen counts.\n\n\n\nThe 2016 season was definitely unusual: the total amount of pollen produced on average (median) is below 1000, but in 2016 it nearly reached 4000 pollen grains/m³ per year.\n\nBut the 2016 peak concentrations aren’t unusually high - ie. not the type of outlier due to a typo.\n\nIn fact, it looks like in 2016 the period with days where pollen concentrations stayed relatively high was unusually long, while for the other seasons, this period is much more transient and tails off quickly.\n\nSo 2016 doesn’t look like an outlier that should be removed - quite the opposite, we might want to study it closely, to learn something about the factors associated with high seasonal pollen totals.\n\nQuantile-quantile plots\n\nQuantile-quantile (Q-Q) plots are a quick graphical method for comparing two distributions: if the two distributions corrrespond to each other, the quantiles from one plotted against the other will follow a 45° diagonal line (y = x).\n\nOften a set of actual observations (y axis) is compared to a theoretical distribution such as the normal disrtibution (x axis).\n\nSuch a normal quantile plot shows how much the distribution of the observed data follow or deviates from the Gaussian.\n\nA strength of normal quantile plots is that data points in the tail of the distribution are much better visualised - of course this is where we expect to find outliers.\n\nI like normal quantile plots because of the intuitive understanding they give of a dataset. The central tendency, variability and skewness are instantly visualised.\n\n\n\nIn the present case, I don’t necessarily care whether a pollen season metric follows a Gaussian distribution specifically, but about quickly identifying if the extreme data in a normal quantile plot look like potential outliers : do they fall close to the 45° diagonal line? If not, do they deviate in a way similar to the other observations?\n\nThis is quite similar to the strategy of using z-scores to identify unusual observations that are worth checking. The advantage of the normal quantile plots is that potential outliers are shown in the context of the other 29 seasons.\n\nIn the 4 normal quantile plots above, each has one or two data points that look unusual. From our previous inspection of the underlying pollen counts, we can be confident that only the top row (hazel season duration, birch date of last pollen) is due to erroneous pollen data. The bottom row (alder season total, grasses season duration using moving averages) are genuine data points that are unusual due to “freak events”, in this case probably unusual weather or mast seeding years.\n\nWhat this shows is that it is usually not enough to just look at how extreme a data point is, some domain knowledge is required to make a judgement as to which data points are unusual and which are impossible.\n\nOutliers distort outlier detection methods\nWhat is the effect removing the implausible observations by setting the value of the pollen concentration to 0? Here are normal quantile plots for before/after cleaning (blue/red). The top row shows the actual values of the observations on the y-axis, the bottom the corresponding quantiles.\n\n\n\nFor the duration of the hazel season (1-99% of APIn), cleaning corrects two extreme data points, while the other values remain the same. In the bottom row we can see how correcting the outliers impacts the shape of the whole distribution: it follow the 45° line representing the Gaussian more closely.\n\nFor the end of the birch season (last day of the year with birch pollen), cleaning corrects a handful of data points. Some of these end up closer to the median of the distribution, causing the cleaned distribution to shift to the right. Again, as shown in the bottom row, after data cleaning the data points follow a normal distribution much more closely.\n\nThe impact of the removal of erroneous pollen data on the whole distribution shows another noteworthy - and slightly ironic - phenomenon: most methods for outlier detection are themselves sensitive to the presence of outliers.\n\nIn other words, the presence of outliers make other data points look less unusual than they are, whether we use their z-score or their position in the context of the whole data set on a normal quantile plot.\n"
} ,
  
  {
    "title"    : "What does a pollen season look like?",
    "category" : "viz, time-series, pollen",
    "url"      : "/viz/time-series/pollen/2021/11/22/How-to-visualise-pollen-seasons/",
    "date"     : "November 22, 2021",
    "excerpt"  : "Plants release pollen in a phenological process : the pollen season. As pollen allergy suffers know, these seasons repeat every year in a similar way - but there is also great variability, at the level of daily observations, between seasons and be...",
    "content"  : "Plants release pollen in a phenological process : the pollen season. As pollen allergy suffers know, these seasons repeat every year in a similar way - but there is also great variability, at the level of daily observations, between seasons and between plants. This post presents ways of visualising pollen time-series data so to gain a sense of how a pollen season unfolds as well as how pollen seasons vary.\n\nPollen concentrations vary from day to day. On the left are daily observations of the concentration of birch pollen in 2006. It starts in mid-April, it fades out from mid-May. The bulk of pollen is seen in the second half of April. This is the main pollen season: people allergic to birch pollen will see strong symptoms when the concentration is above 50 or 100 pollen grains /m³.\n\n\n\nBut pollen concentrations are also vary from season to season. On the right are daily concentrations of 30 seasons of birch pollen. Each season happens around the same time of the year, but the day-to-day variability as well as the season-to-season variability are considerable.\n\nTo smooth the daily variations out, we can use rolling averages. Below are 10 randomly selected seasons, showing the rolling mean, averaged over different-sized windows.\n\n\n\nUsing a rolling average makes the visualisation less busy, and gives a better sense of the intensity of the main season, as well as the differences between seasons.\n\nBut if the interval over which the rolling average is calculated becomes too long, the granularity of daily observations is lost. As peak days get flattened, the coloured area is primarily a visualisation of the start and end of the seasons, as well as the amount of pollen released in total.\n\nA second way of making the graph less busy is to use the cumulative sum of daily pollen concentrations. This is shown on the left for the same 10 seasons as above.\n\n\n\nThe cumulatively summing the daily observations gives an even better sense of the differences in timing between seasons, and the total pollen released each year. The granularity of daily obervations is not lost, but shown in context.\n\nIf we normalise the cumulative sum, we get a sense of how similar the unfolding dynamic of each season is: though each season starts at a different time, once the birch trees get going, they release a lot of pollen in a short time. With trees like birch, we usually pass fom 20% to 80% of a season’s total pollen in very few days.\n\nHowever, even the normalised cumulative sum can be too busy if we want to look at the decades of pollen measurements in the dataset (LHS and middle panels below). So here’s one of my favourite ways of visualising pollen season : the functional boxplot (RHS panel).\n\n\n\nIn the functional boxplot, the thicker black curve is a ‘median’ curve that summarises all the seasons. The dark grey central region includes 50% of pollen observations.\n\nOutlier seasons are shown individually. Notice something? the ‘too late’ outliers are mostly in the 90s and 0s, the ‘too early’ outliers are mostly in the 2010s. More on that another time.\n\nWhat happens if we combine rolling means and functional boxplots? The figure below shows how a very busy visualisation of 30 years of daily grass pollen concentrations can be cleaned up, first by calculating a rolling average, normalised using the median season total.\n\n\n\nThe lower panel represents the same data as a functional boxplot, emphasising the region containing 50% of observations (grey), and outlier seasons. This is without using cumulative concentrations. It works best for grass pollen, which have quite a long, less variable season.\n\nSo to summarise:\n\n  rolling averages are a good way of smoothing out daily variability ;\n  cumulative sums are good for visualising the progression of a dpollen season ;\n  normalisation of cumulative sums is best for comparing season progression and timing - especially in a functional boxplot.\n\n\nWhat if we combine all of these methods from our box of tricks?\n\nLet’s first visualise all the tree pollen seasons:\n\n\n\nThat’s daily observations of 20 species over 30 years, so 600 seasons. The daily observations vary over 3 orders of magnitude of pollen concentrations. Quite a muddle!\n\nNow here’s what happens if we separate the same data by plant species, and use rolling means, cumulative normalised sums with functional boxplots.\n\nThis way we can visualise when each tree pollen season normally occurs, as well as the seasons that were different from that norm.i87\n\n\n\nAnd there we have it: order from chaos, an intuitive understanding of 600 tree pollen seasons, 30 years worth of observations made at a daily frequency.\n"
} ,
  
  {
    "title"    : "A lockdown project that became something bigger",
    "category" : "pollen",
    "url"      : "/pollen/2021/11/15/Looking-at-Pollen/",
    "date"     : "November 15, 2021",
    "excerpt"  : "I’m setting up this blog to document and reflect on some work I did on a dataset of aerobiological pollen measurements, to share methods I used and insights I gained.\n\nA few weeks before last winter’s lockdown, in search for a real world dataset, ...",
    "content"  : "I’m setting up this blog to document and reflect on some work I did on a dataset of aerobiological pollen measurements, to share methods I used and insights I gained.\n\nA few weeks before last winter’s lockdown, in search for a real world dataset, mainly as an exercise for time-series analysis and visualisation as well as some predictive modelling, I started looking at data from the aerobiology station in Luxembourg (publicly available at pollen.lu).\n\nIt’s a great dataset, covering 30 continuous years of pollen measurements, taken at a daily frequency, of 33 different types of trees, grass and weeds. It also contains daily measurements of several types of fungal spores. The data are very clean and consistent, probably because, over the three decades, the measurements have been taken by the same team of people and the pollen trap was never moved.\n\nThe more I looked at the data, the more interested I got in it. Pollen research takes place at the unusual intersection of medicine (due to medical relevance of pollen allergies), botany (particularly phenology, which studies periodic events of biological life cycles), and meteorology (because pollen concentrations are largely determined by weather conditions). \n\nBut there’s also a link to climate change: since weather conditions influence pollen concentrations, climate change is reflected in pollen data. And therefore a 30 year-long time-series of pollen concentrations provides a detailed record of the impact climate change has had on vegetation.\n\nSo, when last winter’s lockdown was announced, this pollen analysis project became something bigger, as I wanted to do something useful with my time.\n\nAn in-depth analysis of the data has now been accepted for publication in the Bulletin de la Société des Sciences Médicales du Grand Duché de Luxembourg. So this seems like the right moment to reflect on and document some of the work I’ve done for it.\n\nI’m going to talk about things like cleaning of these time-series data, trend analysis, getting a handle on the variability, mast seeding.\n\nIt’s also very interesting from a data analysis/modelling perspective, because the data (both pollen and weather) are solid but analysis and modelling are surprsingly challenging. I learnt how to apply a number of methods, which I want to describe in this series of blog posts.\n\n"
} 
  
]
